<!-- Bootstrap -->
    <link href="./modules/drawMyReport/include/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-2.0.0.min.js"></script>

    <script src="./modules/drawMyReport/include/js/bootstrap.min.js"></script>

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="./modules/drawMyReport/include/js/jsapi.js"></script>

    <script type="text/javascript" src="./modules/drawMyReport/include/js/base.js"></script>
    <script type="text/javascript" src="./modules/drawMyReport/include/js/html2canvas.js"></script>


<?php 
include './modules/drawMyReport/DB-Func.php';

if ($_POST["create_report"]) {
  global $conf_centreon;

  $db = dbConnect($conf_centreon['hostCentreon'], $conf_centreon['user'], $conf_centreon['password'],$conf_centreon['db'], true);
  $error=0;

  $result = mysql_query("INSERT INTO drawmyreport_reports (name, title, subtitle) VALUES('".$_POST["create_report"]["name"]."','".$_POST["create_report"]["title"]."','".$_POST["create_report"]["subtitle"]."');");
  $report_id = mysql_insert_id();

  if ($_POST["create_report"]["graphs"]) {
    $post_graphs_array = $_POST["create_report"]["graphs"];
    for ($i = 0; $i < count($post_graphs_array); $i++) {
      if ($post_graphs_array[$i] !== "-") {
        mysql_query("INSERT INTO drawmyreport_report_graphs (report_id, graph_id) VALUES('".$report_id."','".$post_graphs_array[$i]."');");
      }
    }
  }

  $_POST=Array();
  dbClose($db);
}

if (isset($_POST["edit_report"])) {
  global $conf_centreon;

  $db = dbConnect($conf_centreon['hostCentreon'], $conf_centreon['user'], $conf_centreon['password'],$conf_centreon['db'], true);
  $error=0;

  $result = mysql_query("UPDATE drawmyreport_reports SET name = '".$_POST["edit_report"]["name"]."', title = '".$_POST["edit_report"]["title"]."', subtitle = '".$_POST["edit_report"]["subtitle"]."' WHERE id = '".$_POST["edit_report"]["id"]."';");
  $report_id = $_POST["edit_report"]["id"];

  if (isset($_POST["edit_report"]["graphs"])) {
    $post_graphs_array = $_POST["edit_report"]["graphs"];
    for ($i = 0; $i < count($post_graphs_array); $i++) {
      if ($post_graphs_array[$i] !== "-") {
        mysql_query("INSERT INTO drawmyreport_report_graphs (report_id, graph_id) VALUES('".$report_id."','".$post_graphs_array[$i]."');");
      }
    }
  }
  
  if (isset($_POST["edit_report"]["graphs_delete"])) {
    $post_graphs_array = $_POST["edit_report"]["graphs_delete"];
    for ($i = 0; $i < count($post_graphs_array); $i++) {
      if ($post_graphs_array[$i] !== "-") {
        mysql_query("DELETE FROM drawmyreport_report_graphs WHERE graph_id='".$post_graphs_array[$i]."' AND report_id='".$report_id."';");
      }
    }
  }

  $_POST=Array();
  dbClose($db);
}

function addSelectGraph($graphs_array) {
  $str = '<div class="select-parent"><select type="text" class="form-control" name="create_email[users][]" placeholder="Select an user">
          <option value="-">-</option>';
  for ($i = 0; $i < count($graphs_array); $i++) {
    $str .= '<option value="'.$graphs_array[$i]->id.'">'.$graphs_array[$i]->name.'</options>';
  }

  $str .= '</select></div><br><button class="xs-btn btn-default add-graph-report" target="#select-graph-report-model">Add an user</button>';
  return $str;
}
?>


<div class="container">

<a href="#" class="create-graph">Create an email</a>
<div>
<form class="form col-lg-6" hidden role="form" id="form-create-graph" method="post" action="">
  <h3>New email <a href="#form-create-graph" class="close-create-graph" title="close form">close</a></h3>
    <div class="input-group">
      <span class="input-group-addon">Name</span>
      <input type="text" class="form-control" name="create_email[name]" placeholder="Name">
    </div>
    <br>
    <div class="input-group">
      <span class="input-group-addon">Title</span>
      <input type="text" class="form-control" name="create_email[title]" placeholder="Title">
    </div>
    <br>
    <div class="input-group">
      <span class="input-group-addon">Date of first sending</span>
      <input type="text" class="form-control" name="create_email[date_first_send]" placeholder="yyyy-mm-dd hh:mm:ss">
    </div>
    <input type="hidden" class="form-control" name="create_email[date_last_modification]" value="<?php echo time(); ?>">
    <br>

<?php
global $conf_centreon;

$db = dbConnect($conf_centreon['hostCentreon'], $conf_centreon['user'], $conf_centreon['password'],$conf_centreon['db'], true);
$graphs_list = mysql_query("SELECT * FROM drawmyreport_users;");
$graphs_array = array();

while ($graph_row = mysql_fetch_object($graphs_list)) {
  array_push($graphs_array, $graph_row);
}

dbClose($db);

?>
    <div class="input-group-btn" id="select-graphs-list-report">
        <span class="input-group-addon">Users</span>
        <div id="select-graph-report-model">
            <?php echo addSelectGraph($graphs_array); ?>
        </div>
    </div>
    <br>

    <button class="btn btn-primary" type="submit">Save</button>
  </form>
</div>

<hr>


<div class="col-lg-12">
    <h4>List of emails</h4>
<?php 
  global $conf_centreon;

  $db = dbConnect($conf_centreon['hostCentreon'], $conf_centreon['user'], $conf_centreon['password'],$conf_centreon['db'], true);

  $reports_list = mysql_query("SELECT * FROM drawmyreport_emails;");
  dbClose($db);
?>
<table class="table">
  <tr>
    <th>Name</th>
    <th>Title</th>
    <th>Date first sending</th>
    <th>Date last sending</th>
    <th>Date last modification</th>
    <th>Actions</th>
  </tr>
<?php
    while ($row = mysql_fetch_object($reports_list)) {
?>
  <tr data-topic-id="<?php echo $row->id ?>">
      <td><?php echo $row->name ?></td>
      <td><?php echo $row->title ?></td>
      <td><?php echo $row->date_first_send ?></td>
      <td><?php echo $row->date_last_send ?></td>
      <td><?php echo $row->date_last_modification ?></td>
      <td><a href="main.php?p=90103&report=<?php echo $row->id ?>" title="See preview" class="see-report-preview"><span class="glyphicon glyphicon-play"></span></a> 
<a href="./modules/drawMyReport/include/php/edit-report.php?report_id=<?php echo $row->id ?>" title="Edit" class="edit-report"><span class="glyphicon glyphicon-pencil"></span></a> 
<a href="./modules/drawMyReport/include/php/delete-report.php?report_id=<?php echo $row->id ?>" title="Remove" class="remove-graph"><span class="glyphicon glyphicon-trash"></span></a></td>
  </tr>      
<?php
    }
?>
</table>
</div>

</div>
